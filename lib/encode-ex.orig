defprotocol XMLStreamTools.Encoder do
  @moduledoc """
  A protocol for encoding a map to an XML stream.
  """

  @doc """
  Encode a map to an XML stream.
        
  The map is encoded to an XML stream using the provided `opts`.
        
  The `opts` map can contain the following keys:
  - `:tag` - the tag to use for the root element, defaults to "root"
  """
  @spec encode(map, Keyword.t) :: Enumerable.t
  def encode(map, opts)
end

defimpl XMLStreamTools.Encoder, for: String do
  @spec encode(string, Keyword.t) :: Enumerable.t
  def encode(string, opts), do: [string]
end

defimpl XMLStreamTools.Encoder, for: Enumerable do
  @spec encode(enumerable, Keyword.t) :: Enumerable.t
  def encode(enumerable, opts) do
    tag = Keyword.get(opts, :tag, "item")
    Enum.flat_map(enumerable, fn x -> ["<#{tag}>#{encode(x, opts)}<#{tag}>"] end)
  end
end

defimpl XMLStreamTools.Encoder, for: Map do
  @spec encode(map, Keyword.t) :: Enumerable.t
  def encode(map, opts) do
    tag = Keyword.get(opts, :tag, "root")
    encode_map(map, opts))
  end

  defp encode_map(map, opts) do
    Enum.map(map, fn {k, v} -> encode_element(k, v, opts) end)
  end

  defp encode_element(k, v, opts) do
    case k do
      :_meta -> []
      :_namespace -> []
      _ -> encode_tag(k, v, opts)
    end
  end

  defp encode_tag(k, v, opts) do
    case v do
      map when is_map(map) -> Enum.concat(["<#{k}"], encode_map(map, opts))
      list when is_list(list) -> Enum.concat(["<#{k}>"], encode_list(list, opts))
      _ -> ["<#{k}>#{v}</#{k}>"]
    end
  end

  defp encode_list(list, opts) do
    Enum.map(list, fn v -> encode_list_element(v, opts) end)
  end

  defp encode_list_element(v, opts) do
    case v do
      map when is_map(map) -> Enum.concat(["<item"], encode_map(map, opts))
      list when is_list(list) -> Enum.concat(["<item"], encode_list(list, opts))
      _ -> ["<item>#{v}</item>"]
    end
  end
end
